<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>asyncio &#8212; PowrUsr Docs alpha documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../_static/pydoctheme.css?v=aa5eeaf2" />
    <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css?v=b20cc3f5" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=c6eb1e0f" />
    
    <script src="../_static/documentation_options.js?v=1f169f65"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="core" href="core.html" />
    <link rel="prev" title="assert" href="assert.html" /><link rel="stylesheet" href="../_static/pydoctheme_dark.css" media="(prefers-color-scheme: dark)" id="pydoctheme_dark_css">
    <link rel="shortcut icon" type="image/png" href="../_static/py.svg" />
            <script type="text/javascript" src="../_static/copybutton.js"></script>
            <script type="text/javascript" src="../_static/menu.js"></script>
            <script type="text/javascript" src="../_static/search-focus.js"></script>
            <script type="text/javascript" src="../_static/themetoggle.js"></script> 
  </head>
<body>
<div class="mobile-nav">
    <input type="checkbox" id="menuToggler" class="toggler__input" aria-controls="navigation"
           aria-pressed="false" aria-expanded="false" role="button" aria-label="Menu" />
    <nav class="nav-content" role="navigation">
        <label for="menuToggler" class="toggler__label">
            <span></span>
        </label>
        <span class="nav-items-wrapper">
            <a href="https://www.python.org/" class="nav-logo">
                <img src="../_static/py.svg" alt="Logo"/>
            </a>
            <span class="version_switcher_placeholder"></span>
            <form role="search" class="search" action="../search.html" method="get">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="search-icon">
                    <path fill-rule="nonzero" fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 001.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 00-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 005.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
                </svg>
                <input placeholder="Quick search" aria-label="Quick search" type="search" name="q" />
                <input type="submit" value="Go"/>
            </form>
        </span>
    </nav>
    <div class="menu-wrapper">
        <nav class="menu" role="navigation" aria-label="main navigation">
            <div class="language_switcher_placeholder"></div>
            
<label class="theme-selector-label">
    Theme
    <select class="theme-selector" oninput="activateTheme(this.value)">
        <option value="auto" selected>Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</label>
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">main</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ai/index.html">ai</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinx.html">sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bash/index.html">bash</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">python</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="assert.html">assert</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="core.html">core</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataclass.html">dataclasses</a></li>
<li class="toctree-l2"><a class="reference internal" href="designpatterns.html">design patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_ops.html">glob</a></li>
<li class="toctree-l2"><a class="reference internal" href="functional.html">functional programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="fundamentals.html">fundamentals</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="pandas.html">pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="pyenv.html">pyenv</a></li>
<li class="toctree-l2"><a class="reference internal" href="regex.html">regex</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html">typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html#annotated-typing">annotated typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html#pedantic">pedantic</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">code library</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../vim/index.html">vim</a></li>
</ul>

  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">asyncio</a><ul>
<li><a class="reference internal" href="#async-but-not-concurrent">async but not concurrent</a></li>
<li><a class="reference internal" href="#async-concurrent">async &amp; concurrent</a></li>
<li><a class="reference internal" href="#aiohttp">aiohttp</a></li>
<li><a class="reference internal" href="#websockets">websockets</a></li>
<li><a class="reference internal" href="#producer-consumer">producer-consumer</a><ul>
<li><a class="reference internal" href="#consumer-py">consumer.py</a></li>
<li><a class="reference internal" href="#producer-py">producer.py</a></li>
<li><a class="reference internal" href="#resulthandler-py">resulthandler.py</a></li>
<li><a class="reference internal" href="#controller-py">controller.py</a></li>
<li><a class="reference internal" href="#main-py">main.py</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </nav>
    </div>
</div>
  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="core.html" title="core"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="assert.html" title="assert"
             accesskey="P">previous</a> |</li>
          <li><img src="../_static/py.svg" alt="python logo" style="vertical-align: middle; margin-top: -1px"/></li>
          <li><a href="https://www.python.org/">Python</a> &#187;</li>
          <li class="switchers">
            <div class="language_switcher_placeholder"></div>
            <div class="version_switcher_placeholder"></div>
          </li>
          <li>
              
              <a href="../index.html">PowrUsr Docs alpha documentation</a> &#187;
              
          </li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">python</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">asyncio</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../search.html" method="get">
          <input placeholder="Quick search" aria-label="Quick search" type="search" name="q" id="search-box" />
          <input type="submit" value="Go" />
        </form>
    </div>
                     |
                </li>
            <li class="right">
<label class="theme-selector-label">
    Theme
    <select class="theme-selector" oninput="activateTheme(this.value)">
        <option value="auto" selected>Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</label> |</li>
            
      </ul>
    </div>    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="asyncio">
<h1>asyncio<a class="headerlink" href="#asyncio" title="Link to this heading">¶</a></h1>
<section id="async-but-not-concurrent">
<h2>async but not concurrent<a class="headerlink" href="#async-but-not-concurrent" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">151</span><span class="p">):</span>
            <span class="n">pokemon_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://pokeapi.co/api/v2/pokemon/</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pokemon_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">pokemon</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">bulbasaur</span>
<span class="go">ivysaur</span>
<span class="go">venusaur</span>
<span class="go">...</span>
<span class="go">dratini</span>
<span class="go">dragonair</span>
<span class="go">dragonite</span>
<span class="go">mewtwo</span>
<span class="go">--- 6.3120012283325195 seconds ---</span>
</pre></div>
</div>
</section>
<section id="async-concurrent">
<h2>async &amp; concurrent<a class="headerlink" href="#async-concurrent" title="Link to this heading">¶</a></h2>
<p>When we await this call to asyncio.gather, we get back an iterable for all of the futures that were passed in, maintaining their order in the list. This way we’re only awaiting one time</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_pokemon</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="n">pokemon</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">151</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://pokeapi.co/api/v2/pokemon/</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">get_pokemon</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">)))</span>

        <span class="n">original_pokemon</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">original_pokemon</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pokemon</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">bulbasaur</span>
<span class="go">ivysaur</span>
<span class="go">venusaur</span>
<span class="go">charmander</span>
<span class="go">charmeleon</span>
<span class="go">...</span>
<span class="go">dratini</span>
<span class="go">dragonair</span>
<span class="go">dragonite</span>
<span class="go">mewtwo</span>
<span class="go">--- 3.4634764194488525 seconds ---</span>
</pre></div>
</div>
</section>
<section id="aiohttp">
<h2>aiohttp<a class="headerlink" href="#aiohttp" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://docs.aiohttp.org/en/stable/index.html">aiohttp docs</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
<section id="websockets">
<h2>websockets<a class="headerlink" href="#websockets" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
<section id="producer-consumer">
<h2>producer-consumer<a class="headerlink" href="#producer-consumer" title="Link to this heading">¶</a></h2>
<section id="consumer-py">
<h3>consumer.py<a class="headerlink" href="#consumer-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;The actual task &#39;worker&#39; or &#39;processor&#39; - the work queue consumer&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">work_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function (coroutine) will perform the actual work, by pulling an item</span>
<span class="sd">    from the work queue, doing some work, and pushing the result</span>
<span class="sd">    to the result queue, and repeating indefinitely.</span>

<span class="sd">    This coroutine never terminates itself - it just keeps looking for work to</span>
<span class="sd">    do in the work_queue. It will instead be terminated by the controller when</span>
<span class="sd">    the controller decides all work has been done.</span>

<span class="sd">    :param work_queue: the work queue the task consumes (pulls from)</span>
<span class="sd">    :param result_queue: the result queue the task pushes a result to</span>
<span class="sd">        once the work is complete</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># grab an item from the queue (if there is one)</span>
        <span class="n">task_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">work_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># read the data we need to perform the work</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">]</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span>

        <span class="c1"># do some work that takes some time - simulated here with an async sleep</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># random wait time up to 2 seconds</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">number</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># push result to result queue</span>
        <span class="k">await</span> <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s2">&quot;time_secs&quot;</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># inform work queue the task is complete</span>
        <span class="n">work_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="producer-py">
<h3>producer.py<a class="headerlink" href="#producer-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;This code defines the producer, which populates the work queue&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">produce_work</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">work_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">producer_completed</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Puts all the requested work into the work queue.</span>

<span class="sd">    :param batch: list of all the params that were submitted to be processed (this is the list of</span>
<span class="sd">        dicts the main application sent over for processing)</span>
<span class="sd">    :param work_queue: main work queue that contains each individual task params</span>
<span class="sd">    :param producer_completed: event to indicate the producer has finished producing</span>
<span class="sd">        all requested work</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">work_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># finished putting all the data into the work queue - indicate we are done using</span>
    <span class="c1"># the producer_completed event</span>
    <span class="n">producer_completed</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="resulthandler-py">
<h3>resulthandler.py<a class="headerlink" href="#resulthandler-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Contains the code to handle results waiting in the result queue&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_task_result</span><span class="p">(</span><span class="n">result_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result item handler</span>
<span class="sd">    This function (coroutine) will handle any results sitting in the result queue by</span>
<span class="sd">    issuing the callback.</span>

<span class="sd">    Just like the task worker, this coroutine never terminates itself. It will instead</span>
<span class="sd">    be terminated by the controller when the controller decides all work has been done.</span>

<span class="sd">    :param result_queue: the result queue this task consumes (pulls from)</span>
<span class="sd">    :param callback: the callback function to call with the results pulled from the queue</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>  <span class="c1"># tell the queue we are done with the item</span>
</pre></div>
</div>
</section>
<section id="controller-py">
<h3>controller.py<a class="headerlink" href="#controller-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Main Controller</span>

<span class="sd">This is the main controller that orchestrates the producer, the &#39;workers&#39; (aka tasks),</span>
<span class="sd">sets up the various queues, and tracks when all work is completed to shut down everything</span>
<span class="sd">and issue the final job completed callback.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">consumer</span>
<span class="kn">import</span> <span class="nn">producer</span>
<span class="kn">import</span> <span class="nn">resulthandler</span>


<span class="c1"># some constants, but could be defined in a config file, or simply passed to run_job function when called</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">WORK_QUEUE_MAX_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">NUM_RESULT_HANDLERS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">RESULT_QUEUE_MAX_SIZE</span> <span class="o">=</span> <span class="mi">100</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_controller</span><span class="p">(</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">task_completed_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">job_completed_callback</span><span class="p">:</span> <span class="n">Callable</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the async controller.</span>

<span class="sd">    :param batch: a list of dictionaries received that defines the parameters for each task that has to run</span>
<span class="sd">    :param task_completed_callback: the callback to use when each task result becomes available</span>
<span class="sd">    :param job_completed_callback: the callback to use when the overall job is completed</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># create the work and result queues</span>
    <span class="n">work_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">WORK_QUEUE_MAX_SIZE</span><span class="p">)</span>
    <span class="n">result_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">RESULT_QUEUE_MAX_SIZE</span><span class="p">)</span>

    <span class="c1"># create a list of all the tasks that will need to run async</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Define the producer task, defining the event we&#39;ll look for when the producer is done</span>
    <span class="n">producer_completed</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">producer_completed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># set the event status to False for starters</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="o">.</span><span class="n">produce_work</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">work_queue</span><span class="p">,</span> <span class="n">producer_completed</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Create the worker (consumer) tasks</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_WORKERS</span><span class="p">):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">do_work</span><span class="p">(</span><span class="n">work_queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># Create the result handler tasks</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_RESULT_HANDLERS</span><span class="p">):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">resulthandler</span><span class="o">.</span><span class="n">handle_task_result</span><span class="p">(</span><span class="n">result_queue</span><span class="p">,</span> <span class="n">task_completed_callback</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># Now wait completion of producer, and kick off the consumers and result handlers</span>
    <span class="k">await</span> <span class="n">producer_completed</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">work_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">result_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># once we reach here, we&#39;re all done, so cancel all tasks</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># all done, callback using the provided callback function</span>
    <span class="n">job_completed_callback</span><span class="p">({</span><span class="s2">&quot;elapsed_secs&quot;</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">run_job</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">task_completed_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">job_completed_callback</span><span class="p">:</span> <span class="n">Callable</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the function caller calls to kick off the job.</span>
<span class="sd">    Note that this function is not a coroutine - it&#39;s a standard function that will run the top-level</span>
<span class="sd">    entry point for our async processing.</span>

<span class="sd">    :param batch: a list of dictionaries received that defines the parameters for each task that has to run</span>
<span class="sd">    :param task_completed_callback: the callback to use when each task result becomes available</span>
<span class="sd">    :param job_completed_callback: the callback to use when the overall job is completed</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_controller</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">task_completed_callback</span><span class="p">,</span> <span class="n">job_completed_callback</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="main-py">
<h3>main.py<a class="headerlink" href="#main-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;This is the main controller for the producer/consumer</span>

<span class="sd">Here we&#39;ll define</span>
<span class="sd">        - the parameters for each task that needs to run,</span>
<span class="sd">        - the callback handler that will handle when each task runs</span>
<span class="sd">            to completion</span>
<span class="sd">        - the callback handler that will handle the message that all tasks</span>
<span class="sd">            have completed</span>

<span class="sd">And finally, we&#39;ll kick off the process using the main() function.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">controller</span> <span class="kn">import</span> <span class="n">run_job</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main app that kicks a &quot;job&quot; that consists of running multiple tasks</span>

<span class="sd">    :param job_id: some job identifier</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># define callbacks, &quot;injecting&quot; the job_id</span>
    <span class="n">task_callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">task_completed_callback_handler</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="n">job_callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">job_completed_callback_handler</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># define the parameters for the tasks that will need to run</span>
    <span class="n">task_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># start job</span>
    <span class="n">run_job</span><span class="p">(</span><span class="n">task_data</span><span class="p">,</span> <span class="n">task_callback</span><span class="p">,</span> <span class="n">job_callback</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">task_completed_callback_handler</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback_message</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task completed in </span><span class="si">{</span><span class="n">job_id</span><span class="si">=}</span><span class="s2">: </span><span class="si">{</span><span class="n">callback_message</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">job_completed_callback_handler</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback_message</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> completed: </span><span class="si">{</span><span class="n">callback_message</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># just to get repeatability in various sleeps we use to simulate long-running processes</span>
    <span class="n">main</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">main</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ai/index.html">ai</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinx.html">sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bash/index.html">bash</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">python</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="assert.html">assert</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="core.html">core</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataclass.html">dataclasses</a></li>
<li class="toctree-l2"><a class="reference internal" href="designpatterns.html">design patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_ops.html">glob</a></li>
<li class="toctree-l2"><a class="reference internal" href="functional.html">functional programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="fundamentals.html">fundamentals</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="pandas.html">pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="pyenv.html">pyenv</a></li>
<li class="toctree-l2"><a class="reference internal" href="regex.html">regex</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">pytest</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html">typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html#annotated-typing">annotated typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="typing.html#pedantic">pedantic</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">code library</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../vim/index.html">vim</a></li>
</ul>

  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">asyncio</a><ul>
<li><a class="reference internal" href="#async-but-not-concurrent">async but not concurrent</a></li>
<li><a class="reference internal" href="#async-concurrent">async &amp; concurrent</a></li>
<li><a class="reference internal" href="#aiohttp">aiohttp</a></li>
<li><a class="reference internal" href="#websockets">websockets</a></li>
<li><a class="reference internal" href="#producer-consumer">producer-consumer</a><ul>
<li><a class="reference internal" href="#consumer-py">consumer.py</a></li>
<li><a class="reference internal" href="#producer-py">producer.py</a></li>
<li><a class="reference internal" href="#resulthandler-py">resulthandler.py</a></li>
<li><a class="reference internal" href="#controller-py">controller.py</a></li>
<li><a class="reference internal" href="#main-py">main.py</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="core.html" title="core"
             >next</a> |</li>
        <li class="right" >
          <a href="assert.html" title="assert"
             >previous</a> |</li>
          <li><img src="../_static/py.svg" alt="python logo" style="vertical-align: middle; margin-top: -1px"/></li>
          <li><a href="https://www.python.org/">Python</a> &#187;</li>
          <li class="switchers">
            <div class="language_switcher_placeholder"></div>
            <div class="version_switcher_placeholder"></div>
          </li>
          <li>
              
              <a href="../index.html">PowrUsr Docs alpha documentation</a> &#187;
              
          </li>
          <li class="nav-item nav-item-1"><a href="index.html" >python</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">asyncio</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../search.html" method="get">
          <input placeholder="Quick search" aria-label="Quick search" type="search" name="q" id="search-box" />
          <input type="submit" value="Go" />
        </form>
    </div>
                     |
                </li>
            <li class="right">
<label class="theme-selector-label">
    Theme
    <select class="theme-selector" oninput="activateTheme(this.value)">
        <option value="auto" selected>Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</label> |</li>
            
      </ul>
    </div>  
    <div class="footer">
    &copy; Copyright 2023, PowrUsr.
    <br />
    This page is licensed under the Python Software Foundation License Version 2.
    <br />
    Examples, recipes, and other code in the documentation are additionally licensed under the Zero Clause BSD License.
    <br />
    
    <br />

    The Python Software Foundation is a non-profit corporation.
<a href="https://www.python.org/psf/donations/">Please donate.</a>
<br />
    <br />

    Last updated on 2024-02-02.
    
    <br />

    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>

  </body>
</html>